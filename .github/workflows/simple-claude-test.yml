name: Claude Code Test

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  test-claude:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Check OAuth Token
        run: |
          if [ -z "${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}" ]; then
            echo "ERROR: CLAUDE_CODE_OAUTH_TOKEN is not set in repository secrets"
            echo "Please add your OAuth token to repository secrets"
            exit 1
          else
            echo "OAuth token is configured"
          fi
          
      - name: Install Claude Code
        run: |
          echo "Installing Claude Code..."
          npm install -g @anthropic-ai/claude-code
          echo "Claude Code installed successfully"
          
      - name: Verify Installation
        run: |
          echo "Verifying Claude Code installation..."
          claude --version
          echo "Installation verification complete"
          
      - name: Test Authentication
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "Testing authentication..."
          echo "console.log('Hello, World!');" > test.js
          echo "Testing Claude Code..."
          timeout 60 claude "What does this JavaScript code do?" test.js
          echo "Claude Code is working correctly!"
          
      - name: Advanced Test
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "Running advanced tests..."
          echo "def divide_numbers(a, b):" > buggy_code.py
          echo "    return a / b" >> buggy_code.py
          echo "" >> buggy_code.py
          echo "def main():" >> buggy_code.py
          echo "    result = divide_numbers(10, 0)" >> buggy_code.py
          echo "    print('Result:', result)" >> buggy_code.py
          echo "" >> buggy_code.py
          echo "if __name__ == '__main__':" >> buggy_code.py
          echo "    main()" >> buggy_code.py
          echo "Created test file with intentional bug"
          timeout 60 claude "Review this Python code and identify any potential issues" buggy_code.py
          echo "Advanced test completed successfully!"
          
      - name: Test Summary
        run: |
          echo "All tests completed!"
          echo "Claude Code is properly integrated with GitHub Actions"
          echo "You can now use Claude Code in your workflows"